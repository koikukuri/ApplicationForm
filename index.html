// 【イベント申し込み専用】締め切り機能・イベント情報取得機能付き

const LINE_CHANNEL_ACCESS_TOKEN = 'ndA7uwQ0+8U5Ob6ggRITQ35b6Z4vzpmyjRQU9njqFDCsR7TIA5j7zXCH5pD/Kk63P9ixCUg3wn/SzYY9V2/VYLWXvzLO4nalpknxlipbZ+narhx8WK1Fz4s7YO1vofv7nzhGZ9z9SN6nAKd4ZJ0p3AdB04t89/1O/w1cDnyilFU=';
const FOLDER_ID = "16-GKXIlzDUh76fqGXQu6Adubh8RFjZJ6";
const SPREADSHEET_ID = '1U3sUHt6pXeIHT5wNqfhX0hOhbazCGq4vJUkPKkIdyM8';

// ▼▼▼【追加】LIFFアプリ起動時にイベント情報を取得するための関数です ▼▼▼
function doGet(e) {
  try {
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    const eventSheet = spreadsheet.getSheetByName("イベント一覧");
    if (!eventSheet) {
      throw new Error("「イベント一覧」シートが見つかりません。");
    }

    const data = eventSheet.getDataRange().getValues();
    let eventInfo = null;

    // 1行目はヘッダーなので、2行目からループ
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const isRecruiting = row[7]; // H列
      if (isRecruiting === true || isRecruiting === '募集中') {
        eventInfo = {
          name: row[0], // A列: イベント名
          date: row[1], // B列: 日
          time: row[2], // C列: 時間
        };
        break; // 最初に見つかった募集中のイベントを使用
      }
    }

    if (eventInfo) {
      return ContentService.createTextOutput(JSON.stringify({ status: "success", data: eventInfo })).setMimeType(ContentService.MimeType.JSON);
    } else {
      return ContentService.createTextOutput(JSON.stringify({ status: "not_found", message: "現在募集中のイベントはありません。" })).setMimeType(ContentService.MimeType.JSON);
    }

  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({ status: "error", message: err.message })).setMimeType(ContentService.MimeType.JSON);
  }
}


// ▼▼▼ フォームから送信されたデータを処理する関数です ▼▼▼
function doPost(e) {
  try {
    const payload = JSON.parse(e.postData.contents);
    
    const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);
    const eventSheet = spreadsheet.getSheetByName("イベント一覧");
    if (!eventSheet) { throw new Error("「イベント一覧」シートが見つかりません。"); }

    // 募集中の最初のイベントを取得
    const eventDataRows = eventSheet.getDataRange().getValues();
    let eventRowIndex = -1;
    for (let i = 1; i < eventDataRows.length; i++) {
        if (eventDataRows[i][7] === true || eventDataRows[i][7] === '募集中') {
            eventRowIndex = i + 1; // シートの行番号 (1-based)
            break;
        }
    }

    if (eventRowIndex === -1) {
        return ContentService.createTextOutput(JSON.stringify({ status: "closed", message: "このイベントは現在募集を締め切っています。" })).setMimeType(ContentService.MimeType.JSON);
    }
    
    const eventData = eventSheet.getRange(`A${eventRowIndex}:H${eventRowIndex}`).getValues()[0];
    const eventName         = eventData[0];
    const eventDate         = eventData[1];
    const eventTime         = eventData[2];
    const maleCapacity      = eventData[3];
    const femaleCapacity    = eventData[4];
    let maleApplicants    = eventData[5];
    let femaleApplicants  = eventData[6];

    if (payload.gender === '男性' && maleApplicants >= maleCapacity) {
      return ContentService.createTextOutput(JSON.stringify({ status: "full", message: "申し訳ありません、男性の枠は満員となりました。" })).setMimeType(ContentService.MimeType.JSON);
    }
    if (payload.gender === '女性' && femaleApplicants >= femaleCapacity) {
      return ContentService.createTextOutput(JSON.stringify({ status: "full", message: "申し訳ありません、女性の枠は満員となりました。" })).setMimeType(ContentService.MimeType.JSON);
    }

    if (payload.gender === '男性') {
      eventSheet.getRange(`F${eventRowIndex}`).setValue(maleApplicants + 1);
    } else if (payload.gender === '女性') {
      eventSheet.getRange(`G${eventRowIndex}`).setValue(femaleApplicants + 1);
    }

    const applicationSheet = spreadsheet.getSheetByName("フォーム回答"); 
    if (!applicationSheet) { throw new Error("「フォーム回答」という名前のシートが見つかりません。"); }

    let imageUrl = "なし";
    let fileBlob = null;
    if (payload.fileData) {
      const [meta, base64] = payload.fileData.split(',');
      const mimeType = meta.split(';')[0].split(':')[1];
      const decodedData = Utilities.base64Decode(base64);
      fileBlob = Utilities.newBlob(decodedData, mimeType, payload.fileName);
    }
    if (fileBlob) {
      const folder = DriveApp.getFolderById(FOLDER_ID);
      const fileName = new Date().getTime() + "_" + payload.fileName;
      const file = folder.createFile(fileBlob.setName(fileName));
      imageUrl = file.getUrl();
    }

    applicationSheet.appendRow([
      new Date(), payload.lineUserId, payload.name, payload.age, payload.gender, payload.prefecture, imageUrl, eventName
    ]);

    const recipient = "kawai@coconazo.com";
    const subject = `【${eventName}】新規申し込みがありました`;
    const mailHtmlBody = `<h2>新規申し込みがありました</h2><p><strong>イベント名:</strong> ${eventName}</p><p><strong>氏名:</strong> ${payload.name || ''}</p><p><strong>LINE User ID:</strong> ${payload.lineUserId || ''}</p><p><strong>身分証URL:</strong> <a href="${imageUrl}">${imageUrl}</a></p>`;
    const mailOptions = { htmlBody: mailHtmlBody };
    if (fileBlob) { 
      mailOptions.attachments = [fileBlob]; 
    }
    MailApp.sendEmail(recipient, subject, "", mailOptions);

    const linePushUrl = "https://api.line.me/v2/bot/message/push";
    const lineMessage = `お申し込みを受け付けました。\n\n【開催日時】\n${eventDate} ${eventTime}\n\nご参加お待ちしております！`;
    const linePayload = { to: payload.lineUserId, messages: [{ type: "text", text: lineMessage }] };
    const lineOptions = { method: "post", headers: { "Content-Type": "application/json", Authorization: "Bearer " + LINE_CHANNEL_ACCESS_TOKEN }, payload: JSON.stringify(linePayload), muteHttpExceptions: true };
    UrlFetchApp.fetch(linePushUrl, lineOptions);

    return ContentService.createTextOutput(JSON.stringify({ status: "success" })).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    Logger.log("エラー: " + err.message);
    return ContentService.createTextOutput(JSON.stringify({ status: "error", message: err.message })).setMimeType(ContentService.MimeType.JSON);
  }
}
