/**
 * LINE Developersコンソールで取得した、あなたのチャネルのアクセストークンを設定してください。
 * スクリプトプロパティに設定することを強く推奨します。
 */
const CHANNEL_ACCESS_TOKEN = PropertiesService.getScriptProperties().getProperty('CHANNEL_ACCESS_TOKEN');

/**
 * 参加者の情報が記載されているスプレッドシートのシート名
 */
const USER_SHEET_NAME = '参加中';

/**
 * デバッグログを記録するシート名
 */
const LOG_SHEET_NAME = 'デバッグログ';

/**
 * ログをスプレッドシートに書き込む関数
 * @param {string} message - 記録するメッセージ
 */
function logToSheet(message) {
  try {
    const spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    let logSheet = spreadsheet.getSheetByName(LOG_SHEET_NAME);
    
    if (!logSheet) {
      logSheet = spreadsheet.insertSheet(LOG_SHEET_NAME);
      logSheet.appendRow(['タイムスタンプ', 'ログメッセージ']);
    }
    
    const timestamp = new Date();
    logSheet.appendRow([timestamp, message]);
  } catch (e) {
    console.error("スプレッドシートへのログ書き込みに失敗しました:", e);
  }
}

/**
 * LIFFアプリからPOSTリクエストを受け取ったときに実行される関数
 */
function doPost(e) {
  logToSheet("doPost関数が開始されました。");
  try {
    const data = JSON.parse(e.postData.contents);
    // ★★★ LIFFアプリから送られてくるのは 'userId' です ★★★
    const userId = data.userId; 

    if (!userId) {
      logToSheet("エラー: LIFFアプリからユーザーIDが送られてきませんでした。");
      throw new Error("ユーザーIDがありません。");
    }
    logToSheet(`クリアしたユーザーのID: 「${userId}」`);

    // --- ★★★ スプレッドシートから名前を検索する機能 ★★★ ---
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(USER_SHEET_NAME);
    if (!sheet) {
      logToSheet(`エラー: シート「${USER_SHEET_NAME}」が見つかりません。`);
      throw new Error(`シート「${USER_SHEET_NAME}」が見つかりません。`);
    }
    logToSheet(`シート「${USER_SHEET_NAME}」を正常に取得しました。`);

    const allData = sheet.getDataRange().getValues();
    let userName = null;
    // B列(インデックス1)でユーザーIDを検索し、一致した行のD列(インデックス3)の名前を取得します
    for (let i = 1; i < allData.length; i++) { // 1行目はヘッダーなのでi=1から
      if (allData[i][1] === userId) { // B列のIDが一致したら
        userName = allData[i][3]; // D列の名前を取得
        break;
      }
    }

    if (!userName) {
        logToSheet(`エラー: シート内でユーザーID「${userId}」に対応する名前が見つかりませんでした。`);
        // 名前が見つからない場合は、LINEのプロフィール名を使うなどの代替案も考えられます
        userName = "名前不明の参加者"; 
    }
    logToSheet(`シートから名前「${userName}」を取得しました。`);
    // --- ここまで ---

    const messageText = `【クリア速報🎉】\n${userName}さんがじゃんけんの謎を解きました！`;
    logToSheet(`作成したメッセージ: ${messageText}`);
    
    const userIdsToSend = allData.slice(1) // ヘッダーを除外
                                 .map(row => row[1]) // B列のIDのみを抽出
                                 .filter(String); // 空のセルを除外
    
    logToSheet(`取得した送信先ユーザーIDの数: ${userIdsToSend.length}件`);
    logToSheet(`取得した送信先ユーザーIDリスト: ${JSON.stringify(userIdsToSend)}`);

    if (userIdsToSend.length === 0) {
      logToSheet("送信先のユーザーIDが0件でした。処理を中断します。");
      return ContentService.createTextOutput(JSON.stringify({ status: 'success', message: 'No users to notify.' }));
    }

    sendPushMessage(userIdsToSend, messageText);
    logToSheet("sendPushMessage関数を呼び出し、処理は正常に終了しました。");

    return ContentService.createTextOutput(JSON.stringify({ status: 'success' }));

  } catch (error) {
    logToSheet(`doPost関数全体でエラーが発生しました: ${error.toString()}`);
    return ContentService.createTextOutput(JSON.stringify({ status: 'error', message: error.toString() }));
  }
}

/**
 * 指定されたユーザーIDリストにプッシュメッセージを送信する
 */
function sendPushMessage(userIds, text) {
  const url = 'https://api.line.me/v2/bot/message/multicast';
  const payload = { to: userIds, messages: [{ type: 'text', text: text }] };
  const options = {
    'method': 'post',
    'contentType': 'application/json',
    'headers': { 'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN },
    'payload': JSON.stringify(payload),
    'muteHttpExceptions': true
  };
  
  logToSheet(`LINE APIに送信する直前のデータ: ${JSON.stringify(payload)}`);
  const response = UrlFetchApp.fetch(url, options);
  const responseCode = response.getResponseCode();
  const responseBody = response.getContentText();
  
  logToSheet(`LINE APIからの応答コード: ${responseCode}`);
  logToSheet(`LINE APIからの応答内容: ${responseBody}`);

  if (responseCode < 200 || responseCode >= 300) {
    throw new Error(`Failed to send messages. Response: ${responseBody}`);
  }
}
