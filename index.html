// 【最終診断コード】成功・失敗に関わらず、必ずログをメールで送信します

function doPost(e) {
  let log = "--- Koi-Kukuri 診断ログ ---\n\n";
  try {
    log += "リクエスト受信時刻: " + new Date() + "\n\n";
    log += "受信データ:\n" + e.postData.contents + "\n\n";

    // --- ここから本番の処理を開始 ---
    const payload = JSON.parse(e.postData.contents);
    log += "データ解析成功。\n";

    const LINE_CHANNEL_ACCESS_TOKEN = "ndA7uwQ0+8U5Ob6ggRITQ35b6Z4vzpmyjRQU9njqFDCsR7TIA5j7zXCH5pD/Kk63P9ixCUg3wn/SzYY9V2/VYLWXvzLO4nalpknxlipbZ+narhx8WK1Fz4s7YO1vofv7nzhGZ9z9SN6nAKd4ZJ0p3AdB04t89/1O/w1cDnyilFU=";
    const FOLDER_ID = "16-GKXIlzDUh76fqGXQu6Adubh8RFjZJ6";
    
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("フォーム回答"); 
    if (!sheet) { 
      throw new Error("「フォーム回答」という名前のシートが見つかりません。"); 
    }
    log += "シート取得成功。\n";

    let imageUrl = "なし";
    let fileBlob = null;

    if (payload.fileData) {
      const [meta, base64] = payload.fileData.split(',');
      const mimeType = meta.split(';')[0].split(':')[1];
      const decodedData = Utilities.base64Decode(base64);
      fileBlob = Utilities.newBlob(decodedData, mimeType, payload.fileName);
      log += "画像データの復元成功。\n";
    }
    
    if (fileBlob) {
      const folder = DriveApp.getFolderById(FOLDER_ID);
      const file = folder.createFile(fileBlob); // ファイル名は復元時に設定済み
      imageUrl = file.getUrl();
      log += "ドライブへの保存成功。\n";
    }

    sheet.appendRow([ new Date(), payload.lineUserId, payload.name, payload.age, payload.gender, payload.prefecture, imageUrl ]);
    log += "スプレッドシートへの書き込み成功。\n";

    const recipient = "kawai@coconazo.com";
    const subject = "【Koi-Kukuri】新規申し込みがありました";
    const mailHtmlBody = `<h2>新規申し込みがありました</h2><p><strong>氏名:</strong> ${payload.name || ''}</p><p><strong>LINE User ID:</strong> ${payload.lineUserId || ''}</p><p><strong>身分証URL:</strong> <a href="${imageUrl}">${imageUrl}</a></p>`;
    const mailOptions = { htmlBody: mailHtmlBody };
    if (fileBlob) { 
      mailOptions.attachments = [fileBlob]; 
    }
    MailApp.sendEmail(recipient, subject, "", mailOptions);
    log += "管理者へのメール通知成功。\n";

    const linePushUrl = "https://api.line.me/v2/bot/message/push";
    const lineMessage = `お申し込みを受け付けました。\n\n【開催日時】\n2025年8月3日(日) 14:00〜16:00\n\nご参加お待ちしております！`;
    const linePayload = { to: payload.lineUserId, messages: [{ type: "text", text: lineMessage }] };
    const lineOptions = { method: "post", headers: { "Content-Type": "application/json", Authorization: "Bearer " + LINE_CHANNEL_ACCESS_TOKEN }, payload: JSON.stringify(linePayload), muteHttpExceptions: true };
    UrlFetchApp.fetch(linePushUrl, lineOptions);
    log += "ユーザーへのLINE通知成功。\n";

    // 全ての処理が成功したことをメールで報告
    MailApp.sendEmail(recipient, "【Koi-Kukuri】処理成功ログ", log);

    return ContentService.createTextOutput(JSON.stringify({ status: "success" })).setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    // エラーが発生した場合、その内容をメールで報告
    log += "\n\n--- エラー発生 ---\n";
    log += "エラーメッセージ: " + err.message + "\n";
    log += "エラー箇所: " + err.stack + "\n";
    
    const recipient = "kawai@coconazo.com"; // あなたのメールアドレス
    MailApp.sendEmail(recipient, "【重要・エラー発生】Koi-Kukuri申し込みフォーム", log);

    return ContentService.createTextOutput(JSON.stringify({ status: "error", message: err.message })).setMimeType(ContentService.MimeType.JSON);
  }
}
